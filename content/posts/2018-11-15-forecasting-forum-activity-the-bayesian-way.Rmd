---
title: Forecasting forum activity the Bayesian way
author: Allen Chang
date: '2018-11-15'
slug: forecasting-forum-activity-the-bayesian-way
categories: []
tags:
  - time series
  - bayes
  - R
output:
  blogdown::html_page:
    toc: true
    toc_float: false
    df_print: kable
draft: true
---

# Introduction

I was reading through Google's unofficial data science blog and came upon a post about Bayesian Structural Time Series Modeling and their bsts R package. I wanted to familiarize myself with time series approaches, as they're relevant for business. I realized I had all the forum data that I had been scraping for the last year contained time series information built into it.

During my participation in the forum, I've noticed that the number of posts 

*** THINK ABOUT UNIQUE USRS TOO? ***

```{r load_packages, message=FALSE, warning=FALSE}
# Time series forecasting using Bayesian structural time series models

library(lubridate)
library(bsts)
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
library(reshape)
```

```{r convert_to_ts, message=FALSE, warning=FALSE}
cm <- readRDS('../../data/time_series_data/cm_dates.RDS')
swd <- readRDS('../../data/time_series_data/cm_dates.RDS')

## summarize time series as raw posts per month
cm.df <- cm %>%
  mutate(post.date = mdy(.$mdy), post.month = month(post.date, label = TRUE), post.year = year(post.date)) %>%
  group_by(post.year, post.month) %>%
  summarise(number.posts = n())

swd.df <- swd %>% 
  select(mdy) %>%
  mutate(post.date = mdy(.$mdy), post.month = month(post.date, label = TRUE), post.year = year(post.date)) %>%
  group_by(post.year, post.month) %>%
  summarise(number.posts = n())

cm.ts <- ts(cm.df$number.posts, start = c(2010, 1), end = c(2017, 12), frequency = 12)  # convert to time series object
swd.ts <- ts(swd.df$number.posts, start = c(2010, 2), end = c(2017, 12), frequency = 12)

```

```{r}
Y <- window(swd.ts, start=c(2010, 2), end=c(2016,12))
y <- log10(Y)
ss <- AddLocalLinearTrend(list(), y)
ss <- AddSeasonal(ss, y, nseasons = 12)
swd.model <- bsts(y, state.specification = ss, niter = 2000, ping=0, seed=2016)

```

```{r}
plot(swd.model)
```

```{r}
burn <- SuggestBurn(0.1, swd.model)
p <- predict(swd.model, horizon = 12, burn = burn, quantiles = c(.025, .975))
plot(p, plot.original = 36)
```

```{r actual_vs_predict, message=FALSE, warning=FALSE}
### LOOK AT ACTUAL VS PREDICTED
d2 <- data.frame(
  # fitted values and predictions
  c(10^as.numeric(-colMeans(swd.model$one.step.prediction.errors[-(1:burn),])+y),
    10^as.numeric(p$mean)), # 12
  # actual data and dates 
  as.numeric(swd.ts), #
  as.Date(time(swd.ts))) #
names(d2) <- c("Fitted", "Actual", "Date")

MAPE <- filter(d2, year(Date)>2016) %>% summarise(MAPE=mean(abs(Actual-Fitted)/Actual))

posterior.interval <- cbind.data.frame(
  10^as.numeric(p$interval[1,]),
  10^as.numeric(p$interval[2,]), 
  subset(d2, year(Date)>2016)$Date)
names(posterior.interval) <- c("LL", "UL", "Date")

d3 <- left_join(d2, posterior.interval, by="Date")

```

```{r}
ggplot(data=d3, aes(x=Date)) +
  geom_line(aes(y=Actual, colour = "Actual"), size=1.2) +
  geom_line(aes(y=Fitted, colour = "Fitted"), size=1.2, linetype=2) +
  theme_bw() + theme(legend.title = element_blank()) + ylab("") + xlab("") +
  geom_vline(xintercept=as.numeric(as.Date("2016-12-01")), linetype=2) + 
  geom_ribbon(aes(ymin=LL, ymax=UL), fill="grey", alpha=0.5) +
  ggtitle(paste0("SWD BSTS -- Holdout MAPE = ", round(100*MAPE,2), "%")) +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab('Year') + ylab('Posts Per Month')
```

```{r}
### Extract the components
components <- cbind.data.frame(
  colMeans(swd.model$state.contributions[-(1:burn),"trend",]),                               
  colMeans(swd.model$state.contributions[-(1:burn),"seasonal.12.1",]),
  as.Date(time(Y)))  
names(components) <- c("Trend", "Seasonality", "Date")
components <- melt(components, id="Date")
names(components) <- c("Date", "Component", "Value")
```

```{r}
### Plot
ggplot(data=components, aes(x=Date, y=Value)) + geom_line() + 
  theme_bw() + theme(legend.title = element_blank()) + ylab("") + xlab("") + 
  facet_grid(Component ~ ., scales="free") + guides(colour=FALSE) + 
  theme(axis.text.x=element_text(angle = -90, hjust = 0))
```

```{r}
cm.Y <- window(cm.ts, start=c(2010, 1), end=c(2016,12))
cm.y <- log10(cm.Y)
cm.ss <- AddLocalLinearTrend(list(), cm.y)
cm.ss <- AddSeasonal(cm.ss, cm.y, nseasons = 12)
cm.model <- bsts(cm.y, state.specification = cm.ss, niter = 2000, ping=0, seed=2016)
```

```{r}
plot(cm.model)
```

```{r}
cm.burn <- SuggestBurn(0.1, cm.model)
cm.p <- predict(cm.model, horizon = 12, burn = cm.burn, quantiles = c(.025, .975))
plot(cm.p, plot.original = 36)
```

```{r message=FALSE, warning=FALSE}
### LOOK AT ACTUAL VS PREDICTED
d2 <- data.frame(
  # fitted values and predictions
  c(10^as.numeric(-colMeans(cm.model$one.step.prediction.errors[-(1:cm.burn),])+cm.y),
    10^as.numeric(cm.p$mean)), # 12
  # actual data and dates 
  as.numeric(cm.ts), #
  as.Date(time(cm.ts))) #
names(d2) <- c("Fitted", "Actual", "Date")

MAPE <- filter(d2, year(Date)>2016) %>% summarise(MAPE=mean(abs(Actual-Fitted)/Actual))

posterior.interval <- cbind.data.frame(
  10^as.numeric(p$interval[1,]),
  10^as.numeric(p$interval[2,]), 
  subset(d2, year(Date)>2016)$Date)
names(posterior.interval) <- c("LL", "UL", "Date")

d3 <- left_join(d2, posterior.interval, by="Date")

```

```{r}
ggplot(data=d3, aes(x=Date)) +
  geom_line(aes(y=Actual, colour = "Actual"), size=1.2) +
  geom_line(aes(y=Fitted, colour = "Fitted"), size=1.2, linetype=2) +
  theme_bw() + theme(legend.title = element_blank()) + ylab("") + xlab("") +
  geom_vline(xintercept=as.numeric(as.Date("2016-12-01")), linetype=2) + 
  geom_ribbon(aes(ymin=LL, ymax=UL), fill="grey", alpha=0.5) +
  ggtitle(paste0("SWD BSTS -- Holdout MAPE = ", round(100*MAPE,2), "%")) +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab('Year') + ylab('Posts Per Month')
```

```{r}
### Extract the components
components <- cbind.data.frame(
  colMeans(cm.model$state.contributions[-(1:cm.burn),"trend",]),                               
  colMeans(cm.model$state.contributions[-(1:cm.burn),"seasonal.12.1",]),
  as.Date(time(cm.Y)))  
names(components) <- c("Trend", "Seasonality", "Date")
components <- melt(components, id="Date")
names(components) <- c("Date", "Component", "Value")
```

```{r}
### Plot
ggplot(data=components, aes(x=Date, y=Value)) + geom_line() + 
  theme_bw() + theme(legend.title = element_blank()) + ylab("") + xlab("") + 
  facet_grid(Component ~ ., scales="free") + guides(colour=FALSE) + 
  theme(axis.text.x=element_text(angle = -90, hjust = 0))
```