---
title: Forecasting forum activity the Bayesian way
author: Allen Chang
date: '2018-11-15'
slug: forecasting-forum-activity-the-bayesian-way
categories: []
tags:
  - time series
  - bayes
  - R
output:
  blogdown::html_page:
    toc: true
    toc_float: false
    df_print: kable
draft: true
---


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>I was reading through Google’s unofficial data science blog and came upon a post about Bayesian Structural Time Series Modeling and their bsts R package. I wanted to familiarize myself with time series approaches, as they’re relevant for business. I realized I had all the forum data that I had been scraping for the last year contained time series information built into it.</p>
<p>During my participation in the forum, I’ve noticed that the number of posts</p>
<p>*** THINK ABOUT UNIQUE USRS TOO? ***</p>
<pre class="r"><code># Time series forecasting using Bayesian structural time series models

library(lubridate)
library(bsts)
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
library(reshape)</code></pre>
<pre class="r"><code>cm &lt;- readRDS(&#39;../../data/time_series_data/cm_dates.RDS&#39;)
swd &lt;- readRDS(&#39;../../data/time_series_data/cm_dates.RDS&#39;)

## summarize time series as raw posts per month
cm.df &lt;- cm %&gt;%
  mutate(post.date = mdy(.$mdy), post.month = month(post.date, label = TRUE), post.year = year(post.date)) %&gt;%
  group_by(post.year, post.month) %&gt;%
  summarise(number.posts = n())

swd.df &lt;- swd %&gt;% 
  select(mdy) %&gt;%
  mutate(post.date = mdy(.$mdy), post.month = month(post.date, label = TRUE), post.year = year(post.date)) %&gt;%
  group_by(post.year, post.month) %&gt;%
  summarise(number.posts = n())

cm.ts &lt;- ts(cm.df$number.posts, start = c(2010, 1), end = c(2017, 12), frequency = 12)  # convert to time series object
swd.ts &lt;- ts(swd.df$number.posts, start = c(2010, 2), end = c(2017, 12), frequency = 12)</code></pre>
<pre class="r"><code>Y &lt;- window(swd.ts, start=c(2010, 2), end=c(2016,12))
y &lt;- log10(Y)
ss &lt;- AddLocalLinearTrend(list(), y)
ss &lt;- AddSeasonal(ss, y, nseasons = 12)
swd.model &lt;- bsts(y, state.specification = ss, niter = 2000, ping=0, seed=2016)</code></pre>
<pre class="r"><code>plot(swd.model)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>burn &lt;- SuggestBurn(0.1, swd.model)
p &lt;- predict(swd.model, horizon = 12, burn = burn, quantiles = c(.025, .975))
plot(p, plot.original = 36)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>### LOOK AT ACTUAL VS PREDICTED
d2 &lt;- data.frame(
  # fitted values and predictions
  c(10^as.numeric(-colMeans(swd.model$one.step.prediction.errors[-(1:burn),])+y),
    10^as.numeric(p$mean)), # 12
  # actual data and dates 
  as.numeric(swd.ts), #
  as.Date(time(swd.ts))) #
names(d2) &lt;- c(&quot;Fitted&quot;, &quot;Actual&quot;, &quot;Date&quot;)

MAPE &lt;- filter(d2, year(Date)&gt;2016) %&gt;% summarise(MAPE=mean(abs(Actual-Fitted)/Actual))

posterior.interval &lt;- cbind.data.frame(
  10^as.numeric(p$interval[1,]),
  10^as.numeric(p$interval[2,]), 
  subset(d2, year(Date)&gt;2016)$Date)
names(posterior.interval) &lt;- c(&quot;LL&quot;, &quot;UL&quot;, &quot;Date&quot;)

d3 &lt;- left_join(d2, posterior.interval, by=&quot;Date&quot;)</code></pre>
<pre class="r"><code>ggplot(data=d3, aes(x=Date)) +
  geom_line(aes(y=Actual, colour = &quot;Actual&quot;), size=1.2) +
  geom_line(aes(y=Fitted, colour = &quot;Fitted&quot;), size=1.2, linetype=2) +
  theme_bw() + theme(legend.title = element_blank()) + ylab(&quot;&quot;) + xlab(&quot;&quot;) +
  geom_vline(xintercept=as.numeric(as.Date(&quot;2016-12-01&quot;)), linetype=2) + 
  geom_ribbon(aes(ymin=LL, ymax=UL), fill=&quot;grey&quot;, alpha=0.5) +
  ggtitle(paste0(&quot;SWD BSTS -- Holdout MAPE = &quot;, round(100*MAPE,2), &quot;%&quot;)) +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab(&#39;Year&#39;) + ylab(&#39;Posts Per Month&#39;)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code>### Extract the components
components &lt;- cbind.data.frame(
  colMeans(swd.model$state.contributions[-(1:burn),&quot;trend&quot;,]),                               
  colMeans(swd.model$state.contributions[-(1:burn),&quot;seasonal.12.1&quot;,]),
  as.Date(time(Y)))  
names(components) &lt;- c(&quot;Trend&quot;, &quot;Seasonality&quot;, &quot;Date&quot;)
components &lt;- melt(components, id=&quot;Date&quot;)
names(components) &lt;- c(&quot;Date&quot;, &quot;Component&quot;, &quot;Value&quot;)</code></pre>
<pre class="r"><code>### Plot
ggplot(data=components, aes(x=Date, y=Value)) + geom_line() + 
  theme_bw() + theme(legend.title = element_blank()) + ylab(&quot;&quot;) + xlab(&quot;&quot;) + 
  facet_grid(Component ~ ., scales=&quot;free&quot;) + guides(colour=FALSE) + 
  theme(axis.text.x=element_text(angle = -90, hjust = 0))</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code>cm.Y &lt;- window(cm.ts, start=c(2010, 1), end=c(2016,12))
cm.y &lt;- log10(cm.Y)
cm.ss &lt;- AddLocalLinearTrend(list(), cm.y)
cm.ss &lt;- AddSeasonal(cm.ss, cm.y, nseasons = 12)
cm.model &lt;- bsts(cm.y, state.specification = cm.ss, niter = 2000, ping=0, seed=2016)</code></pre>
<pre class="r"><code>plot(cm.model)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>cm.burn &lt;- SuggestBurn(0.1, cm.model)
cm.p &lt;- predict(cm.model, horizon = 12, burn = cm.burn, quantiles = c(.025, .975))
plot(cm.p, plot.original = 36)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code>### LOOK AT ACTUAL VS PREDICTED
d2 &lt;- data.frame(
  # fitted values and predictions
  c(10^as.numeric(-colMeans(cm.model$one.step.prediction.errors[-(1:cm.burn),])+cm.y),
    10^as.numeric(cm.p$mean)), # 12
  # actual data and dates 
  as.numeric(cm.ts), #
  as.Date(time(cm.ts))) #
names(d2) &lt;- c(&quot;Fitted&quot;, &quot;Actual&quot;, &quot;Date&quot;)

MAPE &lt;- filter(d2, year(Date)&gt;2016) %&gt;% summarise(MAPE=mean(abs(Actual-Fitted)/Actual))

posterior.interval &lt;- cbind.data.frame(
  10^as.numeric(p$interval[1,]),
  10^as.numeric(p$interval[2,]), 
  subset(d2, year(Date)&gt;2016)$Date)
names(posterior.interval) &lt;- c(&quot;LL&quot;, &quot;UL&quot;, &quot;Date&quot;)

d3 &lt;- left_join(d2, posterior.interval, by=&quot;Date&quot;)</code></pre>
<pre class="r"><code>ggplot(data=d3, aes(x=Date)) +
  geom_line(aes(y=Actual, colour = &quot;Actual&quot;), size=1.2) +
  geom_line(aes(y=Fitted, colour = &quot;Fitted&quot;), size=1.2, linetype=2) +
  theme_bw() + theme(legend.title = element_blank()) + ylab(&quot;&quot;) + xlab(&quot;&quot;) +
  geom_vline(xintercept=as.numeric(as.Date(&quot;2016-12-01&quot;)), linetype=2) + 
  geom_ribbon(aes(ymin=LL, ymax=UL), fill=&quot;grey&quot;, alpha=0.5) +
  ggtitle(paste0(&quot;SWD BSTS -- Holdout MAPE = &quot;, round(100*MAPE,2), &quot;%&quot;)) +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab(&#39;Year&#39;) + ylab(&#39;Posts Per Month&#39;)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>### Extract the components
components &lt;- cbind.data.frame(
  colMeans(cm.model$state.contributions[-(1:cm.burn),&quot;trend&quot;,]),                               
  colMeans(cm.model$state.contributions[-(1:cm.burn),&quot;seasonal.12.1&quot;,]),
  as.Date(time(cm.Y)))  
names(components) &lt;- c(&quot;Trend&quot;, &quot;Seasonality&quot;, &quot;Date&quot;)
components &lt;- melt(components, id=&quot;Date&quot;)
names(components) &lt;- c(&quot;Date&quot;, &quot;Component&quot;, &quot;Value&quot;)</code></pre>
<pre class="r"><code>### Plot
ggplot(data=components, aes(x=Date, y=Value)) + geom_line() + 
  theme_bw() + theme(legend.title = element_blank()) + ylab(&quot;&quot;) + xlab(&quot;&quot;) + 
  facet_grid(Component ~ ., scales=&quot;free&quot;) + guides(colour=FALSE) + 
  theme(axis.text.x=element_text(angle = -90, hjust = 0))</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/unnamed-chunk-13-1.png" width="672" /></p>
</div>
